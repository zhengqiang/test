<?php TPL::output('global/header.tpl.htm'); ?>

<div class="aw-container-wrap">
	<div class="aw-container aw-wecenter">
		<?php if ($this->redirect_message) { ?>
		<?php foreach ($this->redirect_message AS $key => $message) { ?>
		<div class="alert fade in">
			<?php echo $message; ?>
		</div>
		<?php } ?>
		<?php } ?>
		<div class="row aw-content-wrap ht-content-wrap">
			<div class="col-xs-12 col-sm-9 aw-main-content aw-question-content">
				<div class="aw-product-detail-content">
					<h1><?php echo $this->question_info['question_content']; ?><span>&nbsp;&nbsp;<?php echo $this->question_info['sub_title']; ?></span><?php if ((!$this->question_info['lock'] AND ($this->question_info['published_uid'] == $this->user_id OR $this->user_info['permission']['edit_question'])) OR $this->user_info['permission']['is_administortar'] OR $this->user_info['permission']['is_moderator']) { ?><a class="aw-text-color-999" href="publish/<?php echo $this->question_info['question_id'] ?>"><i class="icon-edit"></i><?php _e('编辑'); ?></a><?php } ?></h1>
					<div class="aw-topic-editor" id="question_topic_editor" data-type="question" data-id="<?php echo $this->question_info['question_id']?>">
						<?php foreach($this->question_topics as $key => $val) { ?>
						<a href="topic/<?php echo $val['url_token']; ?>" class="aw-topic-name ht-topic-name" data-id="<?php echo $val['topic_id']; ?>"><span><?php echo $val['topic_title']; ?></span></a>
						<?php } ?>
						<?php if ($this->user_id AND ((!$this->question_info['lock'] AND $this->user_info['permission']['edit_question_topic']) OR $this->user_id == $this->question_info['published_uid'])) { ?><span class="aw-edit-topic"<?php if (sizeof($this->question_topics) == 0) { ?> style="display:none"<?php } ?>><i class="icon-edit"></i><?php _e('编辑标签'); ?></span><?php } ?>
					</div>
					<?php if (sizeof($this->question_topics) == 0 AND $this->user_id AND !$this->question_info['lock']) { ?>
						<div class="aw-notopic-sort">
						<?php if ($this->related_topics) { ?>
						<?php _e('可能属于这些标签'); ?>:
						<?php foreach ($this->related_topics AS $key => $topic_title) { ?><a href="javascript:;" onclick="one_click_add_topic(this, '<?php echo $topic_title; ?>', <?php echo $this->question_info['question_id']; ?>);" class="aw-topic-name ht-topic-name"><span><?php echo $topic_title; ?></span></a> <?php } ?>, <?php _e('都不是'); ?>? <a href="javascript:;" onclick="$('#question_topic_editor .aw-edit-topic').click();"><?php _e('点此添加标签'); ?></a>
						<?php } else { ?>
						<?php _e('没有归属标签, 请帮主题添加标签'); ?>, <a href="javascript:;" onclick="$('#question_topic_editor .aw-edit-topic').click();"><?php _e('点此添加标签'); ?></a>
						<?php } ?>
						</div>
					<?php } ?>
					
					<div class="markitup-box">
						<?php echo $this->question_info['question_detail']; ?>
					
						<?php if ($this->question_info['attachs']) {  ?>
						<div class="aw-comment-upload-img-list">
						<?php foreach ($this->question_info['attachs'] AS $attach) { ?>
						<?php if ($attach['is_image'] AND !in_array($attach['id'], $this->question_info['attachs_ids'])) { ?>
							<a href="<?php echo $attach['attachment']; ?>" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="<?php echo $attach['attachment']; ?>" alt="<?php echo $attach['attach_name']; ?>" /></a>
						<?php } ?>
						<?php } ?>
						</div>
						<?php } ?>
						
						<?php if ($this->question_info['attachs']) {  ?>
						<ul class="aw-comment-upload-file-list">
							<?php foreach ($this->question_info['attachs'] AS $attach) { ?>
							<?php if (!$attach['is_image']) { ?>
								<li><a href="<?php echo download_url($attach['file_name'], $attach['attachment']); ?>"><em class="aw-icon i-upload-file"></em><?php echo $attach['file_name']; ?></a></li>
							<?php } ?>
							<?php } ?>
						</ul>
						<?php } ?>
					</div>
				</div>

				<!-- 推荐文章列表　-->
				<div class="ht-suggest-question">
					<h2>海淘攻略</h2>
					<ul>
						<li><a href="/t/57" target="_blank">海淘第一步：注册美国网购账号</a></li>
						<li><a href="/t/172" target="_blank">海淘第二步：选择和注册转运公司</a></li>
						<li><a href="/t/308" target="_blank">海淘第三步：下单和发货</a></li>
					</ul>
				</div>
				<!-- end 推荐文章列表 -->
				
				<?php if ($this->question_related_list) { ?>
				<div class="ht-perhaps-you-like">
					<h2>也许你还喜欢</h2>
					<div class="ht-product-show">
						<ul>
							<?php foreach($this->question_related_list AS $key => $val) { ?>
							<li>
								<a href="question/<?php echo $val['question_id']; ?>"><img alt="" src="<?php echo get_question_image_attach($val['question_id'], $val['question_detail']); ?>" /></a>
								<p><a href="question/<?php echo $val['question_id']; ?>"><?php echo $val['question_content']; ?></a></p>
							</li>
							<?php } ?>
						</ul>
					</div>
				</div>
				<?php } ?>
				<a name="comments"></a>
				<div class="ht-comment-box">
					<h2>评论</h2>
					<?php if ($this->answers) { ?>
					<div class="ht-comment-list clearfix">
						<?php foreach ($this->answers AS $key => $val) { ?>
						<a name="answer_<?php echo $val['answer_id']?>"></a>
						<dl class="clearfix">
							<dt class="pull-left">
								<a class="aw-user-name" data-id="<?php echo $val['uid']; ?>" href="people/<?php echo $val['url_token']; ?>"><img src="<?php echo get_avatar_url($val['uid'], 'mid'); ?>" alt=""></a>
							</dt>
							<dd class="pull-left">
								<span class="pull-right ht-comment-opera">
									<?php if ($this->user_info['permission']['is_administortar'] ) { ?>
									<a class="aw-text-color-999" href="javascript:;" onclick="$.dialog('commentEdit', {answer_id:<?php echo $val['answer_id']; ?>,attach_access_key:'<?php echo $this->attach_access_key; ?>'});"><i class="icon-edit"></i><?php _e('编辑'); ?></a>
									<?php } ?>
									<?php if ($this->user_id AND $this->user_id != $val['uid']) { ?>

									<a class="agree" onclick="agreeVote(this, '<?php echo $val['user_name']; ?>', <?php echo $val['answer_id']; ?>)"><i class="icon-thumbs-up <?php if ($val['agree_status'] == 1) { ?> active<?php } ?>"></i><b><?php echo $val['agree_count']; ?></b></a><a class="disagree" onclick="disagreeVote(this, '<?php echo $val['user_name']; ?>', <?php echo $val['answer_id']; ?>)"><i class="icon-thumbs-down <?php if ($val['agree_status'] == -1) { ?> active<?php } ?>"></i></a><a href="javascript:;" onclick="$('#answer_content').val('@<?php echo $val['user_name']; ?>: ').focus(); _fix_textarea_focus_cursor_position($('#answer_content')); $.scrollTo($('#answer_form'), 300, {queue:true});">@Ta</a>
									<?php } ?>
								</span>
								<a href="people/<?php echo $val['url_token']; ?>"><?php echo $val['user_name']; ?></a> <span><?php echo date_friendly($val['add_time']); ?></span>
								
								<p><?php echo $val['answer_content']; ?></p>
							</dd>
						</dl>
						<?php } ?>
					</div>
					<?php } ?>
					<?php if ($_GET['single']) { ?>
						<a href="question/<?php echo $this->question_info['question_id']; ?>" class="aw-load-more-content">
							<span><?php _e('查看全部回答'); ?></span>
						</a>
					<?php } ?>
					<?php if ($this->question_info['lock']) { ?>
					<p align="center"><?php _e('该主题目前已经被锁定, 无法添加新回复'); ?></p>
					<?php } else if (!$this->user_id) { ?>
					<p align="center"><?php _e('要回复主题请先<a href="account/login/">登录</a>或<a href="account/register/">注册</a>'); ?></p>
					<?php } else if ($this->user_answered) { ?>
					<p align="center"><?php _e('一个主题只能回复一次'); ?><?php if (get_setting('answer_edit_time')) { ?>, <?php _e('你可以在发言后 %s 分钟内编辑回复过的内容', get_setting('answer_edit_time')); ?><?php } ?></p>
					<?php } else if ((get_setting('answer_self_question') == 'N') && ($this->user_id == $this->question_info['published_uid'])) { ?>
					<p align="center"><?php _e('不能回复自己发布的主题, 你可以修改主题内容'); ?></p>
					<?php } else { ?>
					<dl class="clearfix">
						<dt class="pull-left">
							<a class="aw-user-name" data-id="<?php echo $val['uid']; ?>" href="people/<?php echo $val['uid']; ?>"><img src="<?php echo get_avatar_url($this->user_info['uid'], 'mid'); ?>" alt="" /></a>
						</dt>
						<form action="question/ajax/save_answer/" onsubmit="return false;" method="post" id="answer_form">
			        	<input type="hidden" name="post_hash" value="<?php echo new_post_hash(); ?>" />
			        	<input type="hidden" name="question_id" value="<?php echo $this->question_info['question_id']; ?>" />
						<dd class="pull-left">
							<textarea name="answer_content" class="form-control" id="answer_content" rows="4" placeholder="说点什么吧..."></textarea><br>
							<a class="ht-icon comment pull-right" onclick="ajax_post($('#answer_form'));">评论</a>
						</dd>
						</form>
					</dl>
					<?php } ?>
					
					
				</div>
			</div>
			<!-- 侧边栏 -->
			<div class="col-xs-12 col-sm-3 aw-side-bar ht-side-bar">
				<div class="aw-side-bar-mod ht-side-bar-user ">
					<div class="aw-side-bar-mod-head">
						<?php if ($this->question_info['category_info']) { ?>
						<!-- <ul>
							<li>分类：<?php echo $this->question_info['category_info']['title']; ?></li>
						</ul> -->
						<?php } ?>
						
						<?php if ($this->question_info['buy_link']) { ?>
						<a class="ht-icon buy" href="redirect/id-<?php echo urlencode(base64_encode($this->question_info['buy_link'])); ?>__uid-<?php echo $this->question_info['published_uid']; ?>" target="_blank">去看看</a>
						<?php } ?>
						<span class="ht-sort-tags ht-tooltip <?php if ($this->question_thanks) { ?>active<?php }?>" data-toggle="tooltip" data-original-title="<?php if ($this->question_thanks) { ?>已喜欢<?php } else {?> 喜欢 <?php } ?>" data-placement="top">
							<a href="javascript:;"<?php if (!$this->question_thanks) { ?> onclick="question_thanks(<?php echo $this->question_info['question_id']; ?>, this);"<?php } ?>>
								<i class="icon-heart-empty <?php if ($this->question_thanks) { ?> active<?php } ?>"></i><b><?php echo $this->question_info['thanks_count']; ?></b><span><?php if ($this->question_thanks) { ?>已喜欢<?php } else {?> 喜欢 <?php } ?></span>
							</a>
						</span>
						<span class="ht-sort-tags pull-right">
							<a href="javascript:;" onclick="$.dialog('shareOut', {item_type:'question', item_id:<?php echo $this->question_info['question_id']; ?>});"><i class="icon-share active" data-toggle="tooltip" data-original-title="分享" data-placement="top"></i>分享</a>
						</span>
					</div>
					<div class="aw-side-bar-mod-body">
						
					</div>
					<div class="aw-side-bar-mod-footer">
						<img alt="<?php echo $this->question_info['user_info']['user_name'];?>" src="<?php echo get_avatar_url($this->question_info['published_uid'], 'max'); ?>" />
						<a class="aw-user-name" href="people/<?php echo $this->question_info['user_info']['url_token']; ?>" data-id="<?php echo $this->question_info['user_info']['uid']; ?>"><?php echo $this->question_info['user_info']['user_name'];?></a>
						<p class="aw-text-color-999"><?php echo $this->question_info['user_info']['signature']; ?></p>
						<span class="ht-sort-tags">
							<a href="javascript:;" onclick="$.dialog('inbox', '<?php echo $this->user['user_name']; ?>');"><i class="icon-envelope"></i>发私信</a>
						</span>
						<span class="ht-sort-tags pull-right">
							<a href="javascript:;" onclick="follow_people($(this), <?php echo $this->question_info['user_info']['uid'];?>);">
								<?php if ($this->question_info['published_uid'] != $this->user_id AND $this->user_id) { ?>
									<i data-placement="bottom" title=""  data-toggle="tooltip" class="icon-ok-sign<?php if (!$this->user_follow_check) { ?> aw-active<?php } ?>" data-original-title="<?php if ($this->user_follow_check) { ?><?php _e('取消关注'); ?><?php } else { ?><?php _e('关注'); ?><?php } ?>"></i>
									<?php if ($this->user_follow_check) { ?><?php _e('取消关注'); ?><?php } else { ?><?php _e('关注'); ?><?php } ?>
								<?php } ?>
							</a>
						</span>
						<p class="aw-text-color-999">用户组 : <?php echo $this->question_info['user_info']['user_group']['group_name']; ?></p>
						<p class="aw-text-color-999">积分 : <?php echo $this->question_info['user_info']['integral']; ?></p>
						<p class="aw-text-color-999">金币 : <?php echo $this->question_info['user_info']['coin']; ?></p><!-- Modify by anwsion -->
						<p class="aw-text-color-999">发表于 : <?php echo date_friendly($this->question_info['add_time']); ?></p>
						
						<!-- Modify by anwsion -->
						<?php if ($this->user_info['permission']['is_administortar']) { ?>
						<form action="question/ajax/coin/" method="post" onsubmit="return false" id="coin_form">
							<input type="hidden" name="question_id" value="<?php echo $this->question_info['question_id']; ?>" />
							<div class="ht-point-edit">
								<span class="aw-text-color-999">奖励金币: </span>
								<p>
									<input type="text" name="coin" value="" class="pull-left" /> <button type="button" class="btn btn-default pull-left" onclick="ajax_post($('#coin_form')); return false;">提交</button>
								</p>
							</div>
						</form>
						<?php } ?>
						
						<div class="clearfix"></div>
					</div>
				</div>
			
				<?php if ($this->user_info['permission']['is_administortar'] OR $this->user_info['permission']['is_moderator']) { ?>
				<a href="javascript:;" onclick="ajax_request(G_BASE_URL + '/question/ajax/pull_index/', 'question_id=<?php echo $this->question_info['question_id']; ?>');" class="ht-icon push<?php if ($this->question_info['pull_index']) { ?> active<?php } ?>">推首页</a>
				<?php } ?>
			
				<?php if ($this->question_thanks_users) { ?>
				<div class="aw-side-bar-mod ht-others-people-buy">
					<div class="aw-side-bar-mod-head" style="border-bottom:none;">
						<h3>这些人购买过</h3>
					</div>
					<div class="aw-side-bar-mod-body">
						<?php foreach ($this->question_thanks_users AS $key => $val) { ?>
						<dl>
							<dt class="pull-left">
								<a class="aw-user-name" data-id="<?php echo $val['uid']; ?>" href="people/<?php echo $val['uid']; ?>"><img src="<?php echo get_avatar_url($val['uid'], 'mid'); ?>" alt="" /></a>
							</dt>
							<dd class="pull-left">
								<a class="aw-user-name" data-id="<?php echo $val['uid']; ?>" href="people/<?php echo $val['uid']; ?>"><span><?php echo $val['user_name']; ?></span></a>
								<p><?php echo $val['signature']; ?></p>
							</dd>
						</dl>
						<?php } ?>
					</div>
				</div>
				<?php } ?>
			</div>
			<!-- end 侧边栏 -->
		</div>
	</div>
</div>

<script type="text/javascript">
	ATTACH_ACCESS_KEY = '<?php echo $this->attach_access_key; ?>';
	ITEM_IDS = '<?php echo addslashes($_GET['item_id']); ?>';
	COMMENT_UNFOLD = '<?php echo addslashes($_GET['comment']); ?>';
	QUESTION_ID = <?php echo $this->question_info['question_id']; ?>;
	UNINTERESTED_COUNT = <?php echo get_setting('uninterested_fold'); ?>;
</script>

<script type="text/javascript" src="<?php echo G_STATIC_URL; ?>/js/app/question_detail.js"></script>
<script type="text/javascript">
	$(function()
	{
		$.each($('.markitup-box a'),function(i, e){
			$(e).attr('target','_blank');
		});
	});
</script>

<?php TPL::output('global/footer.tpl.htm'); ?>